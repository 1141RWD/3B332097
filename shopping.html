<!DOCTYPE html>
<html lang="zh-TW">
    <head>
        <meta charset="UTF-8">
        <title>è³¼ç‰©è»Šï½œTechNova</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="style.css">
        <style>
            .cart-item {
                display: flex;
                align-items: center;
                background: #1a1a1a;
                color: white;
                padding: 20px;
                margin-bottom: 20px;
                border-radius: 12px;
                border: 1px solid #333;
                flex-wrap: wrap;
            }
            .cart-item img {
                width: 100px;
                height: 100px;
                object-fit: cover;
                border-radius: 8px;
            }
            .item-info {
                flex: 1;
                margin-left: 20px;
            }
            .item-info h3 {
                margin-bottom: 5px;
                color: #fff;
            }
            .item-info p {
                color: #aaa;
                font-size: 14px;
            }
            .item-spec {
                display: inline-block;
                background: #333;
                padding: 2px 8px;
                border-radius: 4px;
                font-size: 12px;
                margin-top: 5px;
            }
            .quantity-control {
                display: flex;
                align-items: center;
                gap: 15px;
                margin: 0 30px;
            }
            .cart-btn {
                background: #333;
                color: white;
                border: none;
                padding: 5px 12px;
                cursor: pointer;
                border-radius: 5px;
                transition: 0.3s;
            }
            .cart-btn:hover {
                background: #ff4d4d;
            }
            .price-info {
                text-align: right;
                min-width: 120px;
            }
            .remove-link {
                color: #ff4d4d;
                text-decoration: none;
                font-size: 13px;
                cursor: pointer;
                display: block;
                margin-top: 10px;
            }
            .cart-summary {
                background: #1a1a1a;
                padding: 25px;
                border-radius: 12px;
                text-align: right;
                margin-top: 30px;
                border-top: 2px solid #ff4d4d;
                color:#fff;
            }
            .cart-summary h3 {
                font-size: 24px;
                margin-bottom: 20px;
            }
            .checkout-btn {
                background: #ff4d4d;
                color: white;
                border: none;
                padding: 12px 40px;
                font-size: 18px;
                border-radius: 30px;
                cursor: pointer;
                font-weight: bold;
            }
            /* æ‰‹æ©Ÿç‰ˆRWD */
            @media (max-width: 768px) {
                .cart-item {
                    flex-direction: column;
                    align-items: flex-start;
                    padding: 15px;
                }

                .cart-item img {
                    width: 100%;
                    height: 200px;
                    margin-bottom: 15px;
                }

                .item-info {
                    margin-left: 0;
                    margin-bottom: 15px;
                    width: 100%;
                }

                .quantity-control {
                    margin: 10px 0;
                    width: 100%;
                    justify-content: flex-start;
                }

                .price-info {
                    text-align: left;
                    width: 100%;
                    border-top: 1px solid #333;
                    padding-top: 10px;
                    margin-top: 10px;
                }

                .cart-summary {
                    max-width: 100%;
                    margin-top: 20px;
                }

                .total-amount {
                    font-size: 26px;
                }
            }
        </style>
    </head>
    <body>
        <header class="navbar">
            <div class="logo">TechNova</div>
            <div class="right-section">
                <nav id="navMenu">
                    <a href="index.html">é¦–é </a>
                    <a href="products.html">å•†å“</a>
                    <a href="download.html">ä¸‹è¼‰</a>
                    <a href="login.html">ç™»å…¥</a>
                </nav>
                <div class="nav-actions">
                    <a href="shopping.html" class="cart-icon">
                        ğŸ›’ <span id="cartCount">0</span>
                    </a>
                    <div class="menu-toggle" onclick="toggleMenu()">â˜°</div>
                </div>
            </div>
        </header>

        <section class="products" style="max-width: 1000px; margin: 0 auto; padding: 40px 20px;">
            <h2 style="margin-bottom: 30px;">æ‚¨çš„è³¼ç‰©è»Š</h2>

            <div id="cartContainer">
                </div>

            <div class="cart-summary" id="cartSummary" style="display: none;">
                <h3>ç¸½è¨ˆé‡‘é¡ï¼š $<span id="totalPrice">0</span></h3>
                <button class="cart-btn" onclick="clearCart()" style="margin-right: 10px; background: #444;">æ¸…ç©ºè³¼ç‰©è»Š</button>
                <button class="checkout-btn" onclick="checkout()">å‰å¾€çµå¸³</button>
            </div>
        </section>

        <script src="products.js"></script>
        <script>
            let cart = JSON.parse(localStorage.getItem('cart')) || [];

            function renderCart() {
                const container = document.getElementById("cartContainer");
                const summary = document.getElementById("cartSummary");
                container.innerHTML = "";

                if (cart.length === 0) {
                    container.innerHTML = `
                        <div style="text-align:center; padding: 50px;">
                            <p style="font-size: 20px; color: #888;">è³¼ç‰©è»Šå…§ç›®å‰æ²’æœ‰å•†å“</p>
                            <a href="products.html" class="cart-btn" style="display:inline-block; margin-top:20px; text-decoration:none;">å»é€›é€›å§</a>
                        </div>`;
                    summary.style.display = "none";
                    updateBadge();
                    return;
                }

                summary.style.display = "block";
                let total = 0;

                cart.forEach((item, index) => {
                    const product = products.find(p => p.id === item.id);
                    if (product) {
                        const spec = product.specs[item.specIndex || 0];
                        const subtotal = spec.price * item.quantity;
                        total += subtotal;

                        container.innerHTML += `
                            <div class="cart-item">
                                <img src="${spec.img}" alt="${product.name}">
                                <div class="item-info">
                                    <h3>${product.name}</h3>
                                    <div class="item-spec">è¦æ ¼ï¼š${spec.label}</div>
                                    <p style="margin-top:10px;">å–®åƒ¹ï¼š$${spec.price}</p>
                                </div>
                                <div class="quantity-control">
                                    <button class="cart-btn" onclick="changeQuantity(${index}, -1)">-</button>
                                    <span>${item.quantity}</span>
                                    <button class="cart-btn" onclick="changeQuantity(${index}, 1)">+</button>
                                </div>
                                <div class="price-info">
                                    <p style="font-size: 18px; font-weight: bold;">$${subtotal}</p>
                                    <span class="remove-link" onclick="removeItem(${index})">ç§»é™¤é …ç›®</span>
                                </div>
                            </div>
                        `;
                    }
                });

                document.getElementById("totalPrice").innerText = total.toLocaleString();
                updateBadge();
            }

            function changeQuantity(index, delta) {
                cart[index].quantity += delta;
                if (cart[index].quantity <= 0) {
                    removeItem(index);
                } else {
                    saveAndUpdate();
                }
            }

            function removeItem(index) {
                if(confirm("ç¢ºå®šè¦ç§»é™¤é€™é …å•†å“å—ï¼Ÿ")) {
                    cart.splice(index, 1);
                    saveAndUpdate();
                }
            }

            function clearCart() {
                if(confirm("ç¢ºå®šè¦æ¸…ç©ºæ•´å€‹è³¼ç‰©è»Šå—ï¼Ÿ")) {
                    cart = [];
                    saveAndUpdate();
                }
            }

            function saveAndUpdate() {
                localStorage.setItem('cart', JSON.stringify(cart));
                renderCart();
            }

            function updateBadge() {
                const count = cart.reduce((sum, item) => sum + item.quantity, 0);
                document.getElementById("cartCount").innerText = count;
            }
            
            function checkout() {
                // 1. æª¢æŸ¥è³¼ç‰©è»Šæ˜¯å¦æœ‰æ±è¥¿
                if (cart.length === 0) {
                    alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„å–”ï¼");
                    return;
                }

                // 2. æª¢æŸ¥ç™»å…¥ç‹€æ…‹
                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (!user) {
                    alert("è«‹å…ˆç™»å…¥æœƒå“¡å†é€²è¡Œçµå¸³ã€‚");
                    location.href = 'login.html'; // è·³è½‰åˆ°ç™»å…¥é 
                    return;
                }

                // 3. åŸæœ‰çš„çµå¸³æµç¨‹
                const btn = document.querySelector(".checkout-btn");
                const originalText = btn.innerText;

                // æ¨¡æ“¬ç¶²è·¯å‚³è¼¸ç‹€æ…‹
                btn.innerText = "é©—è­‰æœƒå“¡è³‡æ–™...";
                btn.style.opacity = "0.7";
                btn.disabled = true;

                setTimeout(() => {
                    // ç¢ºèªçµå¸³è³‡è¨Šä¸­åŒ…å«æœƒå“¡åç¨±
                    alert(`âœ… è¨‚å–®å·²å®Œæˆï¼\næ„Ÿè¬æ‚¨çš„è³¼è²·ï¼Œ${user.name}ï¼\nå•†å“å°‡å¯„é€è‡³ï¼š${user.address}`);

                    // æ­¸é›¶ä¸¦æ¸…ç©º
                    cart = [];
                    localStorage.setItem('cart', JSON.stringify(cart));
                    renderCart();
                    
                    const countEl = document.getElementById("cartCount");
                    if (countEl) countEl.innerText = "0";
                    
                    btn.innerText = originalText;
                    btn.style.opacity = "1";
                    btn.disabled = false;
                    
                    // çµå¸³å®Œå›é¦–é 
                    location.href = 'index.html';
                }, 1500); 
            }

            function toggleMenu() {
                const menu = document.getElementById("navMenu");
                menu.classList.toggle("active");
            }
            renderCart();

            document.addEventListener("DOMContentLoaded", function() {
                    const user = JSON.parse(localStorage.getItem('currentUser'));
                    const navMenu = document.getElementById("navMenu");
                    const loginLink = navMenu.querySelector('a[href="login.html"]');
                    
                    if (user && loginLink) {
                        loginLink.innerText = "æœƒå“¡ä¸­å¿ƒ";
                        loginLink.href = "profile.html"; // æŒ‡å‘æ–°çš„è©³ç´°è³‡æ–™é 
                    }
                });
        </script>
    </body>
</html>
